class OauthStorage{static get accessTokenKey(){return"access_token"}static get refreshTokenKey(){return"refresh_token"}static get accessScopeKey(){return"scope"}static get tokenTypeKey(){return"token_type"}static get expiresInKey(){return"expires_in"}static get currentOauthState(){return"current_oauth_state"}static saveAccess(e){OauthStorage.set(OauthStorage.accessTokenKey,OauthUtils.safeString(e.accessToken)),OauthStorage.set(OauthStorage.refreshTokenKey,OauthUtils.safeString(e.refreshToken)),OauthStorage.set(OauthStorage.accessScopeKey,OauthUtils.safeString(e.accessScope)),OauthStorage.set(OauthStorage.tokenTypeKey,OauthUtils.safeString(e.tokenType)),OauthStorage.set(OauthStorage.expiresInKey,OauthUtils.safeInt(Math.floor(Date.now()/1e3)+e.expiresIn))}static clearAccess(){OauthStorage.remove(OauthStorage.accessTokenKey),OauthStorage.remove(OauthStorage.refreshTokenKey),OauthStorage.remove(OauthStorage.accessScopeKey),OauthStorage.remove(OauthStorage.tokenTypeKey),OauthStorage.remove(OauthStorage.expiresInKey),OauthStorage.remove(OauthStorage.currentOauthState)}static set(e,t,a=!1){a?"undefined"!=typeof sessionStorage&&sessionStorage.setItem(e,t):"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}static get(e){if("undefined"!=typeof sessionStorage){var t=sessionStorage.getItem(e);if(OauthUtils.assertAvailable(t))return t}if("undefined"!=typeof localStorage){t=localStorage.getItem(e);if(OauthUtils.assertAvailable(t))return t}return null}static remove(e){"undefined"!=typeof localStorage&&localStorage.removeItem(e),"undefined"!=typeof sessionStorage&&sessionStorage.removeItem(e)}static clearAll(e=!1){"undefined"!=typeof localStorage&&localStorage.clear(),e&&"undefined"!=typeof sessionStorage&&sessionStorage.clear()}static set accessToken(e){OauthStorage.set(OauthStorage.accessTokenKey,e)}static get accessToken(){return OauthStorage.get(OauthStorage.accessTokenKey)}static get refreshToken(){return OauthStorage.get(OauthStorage.refreshTokenKey)}static get accessScope(){return OauthStorage.get(OauthStorage.accessScopeKey)}static get expiresIn(){return OauthStorage.get(OauthStorage.expiresInKey)}static get tokenType(){return OauthStorage.get(OauthStorage.tokenTypeKey)}}class OauthUtils{static parseJWT(e){e=e.split(".");return e&&3==e.length?atob(e[1]):null}static hasJWTExpired(e){e=this.parseJson(this.parseJWT(e)),e=e?e.exp:null;return!e||parseInt(e)<Math.floor(Date.now()/1e3)+10}static hasTokenExpired(e){if(e=e||OauthStorage.accessToken,OauthUtils.assertAvailable(e)){if(OauthUtils.parseJWT(e)&&!OauthUtils.hasJWTExpired(e))return!1;if(OauthUtils.assertAvailable(OauthStorage.expiresIn))return parseInt(OauthStorage.expiresIn)<Math.floor(Date.now()/1e3)+10}return!0}static safeString(e){return OauthUtils.assertAvailable(e)?e:""}static safeInt(e){return OauthUtils.assertAvailable(e)?e:0}static assertAvailable(e){return null!=e&&void 0!==e&&""!==e}static count(e){let t=0;for(const a in e)e.hasOwnProperty(a)&&t++;return t}static mergeObj(t,a){return Object.keys(a).forEach(e=>{a.hasOwnProperty(e)&&(Array.isArray(t)?t.push(a[e]):t[this.count(t)]=a[e])}),t}static urlEncodeObject(e){const o=(e,t,a)=>{const s=[];for(const i in e[t]){var r;e[t].hasOwnProperty(i)&&null!==e[t][i]&&void 0!==e[t][i]&&("object"==typeof e[t][i]||Array.isArray(e[t][i])?(r=a+"["+i+"]",this.mergeObj(s,o(e[t],i,r))):s.push(encodeURIComponent(a+"["+i+"]")+"="+encodeURIComponent(e[t][i])))}return s};const t=(e=>{const t=[];if(null!==e&&"object"==typeof e)for(const a in e)e.hasOwnProperty(a)&&null!==e[a]&&void 0!==e[a]&&("object"==typeof e[a]||Array.isArray(e[a])?this.mergeObj(t,o(e,a,a)):t.push(a+"="+encodeURIComponent(e[a])));return t})(e);return 0<t.length?t.join("&"):""}static parseJson(e){try{return JSON.parse(e)}catch(e){return null}}static getUrlParam(e,t){t=t||location.href,t=decodeURIComponent(t),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");const a=new RegExp("[\\?&]"+e+"=([^&#]*)");e=a.exec(t);return null==e?null:e[1]}static stripUrlParams(e){return OauthUtils.assertAvailable(e)?e.split("?")[0]:e}static generateKey(t){OauthUtils.assertAvailable(t)||(t=16);let a="";var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let e=0;e<t;e++)a+=s.charAt(Math.floor(Math.random()*s.length));return a}}class Oauth{constructor(e){if(!OauthUtils.assertAvailable(e.clientId))throw new Error("'clientId' Required");if(this.clientId=e.clientId,!OauthUtils.assertAvailable(e.clientSecret))throw new Error("'clientSecret' Required");if(this.clientSecret=e.clientSecret,!OauthUtils.assertAvailable(e.authorizeUrl))throw new Error("'authorizeUrl'  Required");if(this.authorizeUrl=e.authorizeUrl,!OauthUtils.assertAvailable(e.tokenUrl))throw new Error("'tokenUrl' Required");if(this.tokenUrl=e.tokenUrl,!OauthUtils.assertAvailable(e.verifyTokenUrl))throw new Error("'verifyTokenUrl' Required");this.verifyTokenUrl=e.verifyTokenUrl}authorizeAccess(r){let i=OauthUtils.assertAvailable(r.grant_type)?r.grant_type:OauthGrantType.Client_Credentials;const o=OauthUtils.assertAvailable(r.allowed_grant_types)?r.allowed_grant_types:[],n=OauthUtils.assertAvailable(r.redirect_uri)?r.redirect_uri:OauthUtils.stripUrlParams(location.origin),l=OauthUtils.assertAvailable(r.scope)?r.scope:[];let u=OauthUtils.assertAvailable(r.state)?r.state:OauthUtils.generateKey(32);const c=()=>{switch(i){case OauthGrantType.Auto:i=OauthUtils.assertAvailable(r.user_id)||OauthUtils.assertAvailable(OauthUtils.getUrlParam("code"))?OauthGrantType.Authorization_Code:OauthUtils.assertAvailable(r.username)&&OauthUtils.assertAvailable(r.password)?OauthGrantType.User_Credentials:OauthGrantType.Client_Credentials,o.includes(i)?c():r.callback(!1);break;case OauthGrantType.Authorization_Code:var e,t=OauthUtils.getUrlParam("code"),a=OauthUtils.getUrlParam("error"),s=OauthUtils.getUrlParam("error_description");OauthUtils.assertAvailable(t)?(e=OauthStorage.get(OauthStorage.currentOauthState),(u=OauthUtils.assertAvailable(e)?e:u)===OauthUtils.getUrlParam("state")?this.oauthTokenWithAuthorizationCode(t,n,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(OauthStorage.remove(OauthStorage.currentOauthState),OauthStorage.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken),location.replace(OauthUtils.stripUrlParams(window.location.href))):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&r.callback(!1,e.errorDescription):"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!1)}):"function"==typeof r.callback&&r.callback(!1,"Failed authorize access. CSRF Verification Failed")):OauthUtils.assertAvailable(a)?(OauthStorage.remove(OauthStorage.currentOauthState),OauthUtils.assertAvailable(s)?"function"==typeof r.callback&&r.callback(!1,s):"function"==typeof r.callback&&r.callback(!1,"Failed authorize access")):this.oauthAuthorize(l,n,r.user_id,u);break;case OauthGrantType.User_Credentials:this.oauthTokenWithUserCredentials(r.username,r.password,l,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(OauthStorage.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken)):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&r.callback(!1,e.errorDescription):"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!1)});break;default:OauthGrantType.Client_Credentials;this.oauthTokenWithClientCredentials(l,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(OauthStorage.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken)):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&r.callback(!1,e.errorDescription):"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!1)})}};var e,t,a=e=>{this.oauthRefreshToken(e,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(OauthStorage.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken)):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&(r.callback(!1,e.errorDescription),OauthStorage.clearAccess(),c()):"function"==typeof r.callback&&(OauthStorage.clearAccess(),r.callback(!1)):"function"==typeof r.callback&&r.callback(!1)})};OauthUtils.assertAvailable(OauthUtils.getUrlParam("access_token"))?(e=OauthUtils.getUrlParam("access_token"),OauthUtils.hasTokenExpired(e)?"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!OauthUtils.assertAvailable(e)||e)):(e=OauthStorage.accessToken,t=OauthStorage.refreshToken,OauthUtils.assertAvailable(e)?OauthUtils.hasTokenExpired(e)?OauthUtils.assertAvailable(t)?a(t):c():"function"==typeof r.callback&&r.callback(e):c())}hasExpired(){return OauthUtils.hasTokenExpired(OauthStorage.accessToken)}oauthAuthorize(e,t,a,s){if(!OauthUtils.assertAvailable(t))throw new Error("'redirect_url' Required");OauthStorage.set(OauthStorage.currentOauthState,s,!0);e={client_id:this.clientId,scope:e.join(" "),state:s,response_type:"code",user_id:a,redirect_uri:t},s=this.authorizeUrl+"?"+OauthUtils.urlEncodeObject(e);window.open(s,"_blank")}oauthAuthorizeWithEmail(e,t,a,s){if(!OauthUtils.assertAvailable(t))throw new Error("'redirect_url' Required");OauthStorage.set(OauthStorage.currentOauthState,s,!0);e={client_id:this.clientId,scope:e.join(" "),state:s,response_type:"code",email:a,redirect_uri:t},s=this.authorizeUrl+"?"+OauthUtils.urlEncodeObject(e);window.open(s,"_blank")}oauthAuthorizeImplicit(e,t,a,s){if(!OauthUtils.assertAvailable(t))throw new Error("'redirect_url' Required");if(!OauthUtils.assertAvailable(e))throw new Error("'scope' Required");OauthStorage.set(OauthStorage.currentOauthState,s,!0);e={client_id:this.clientId,scope:e.join(" "),state:s,response_type:"token",user_id:a,redirect_uri:t},s=this.authorizeUrl+"?"+OauthUtils.urlEncodeObject(e);window.open(s,"_blank")}oauthTokenWithClientCredentials(e,a){OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.Client_Credentials,client_id:this.clientId,client_secret:this.clientSecret,scope:e.join(" ")},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)}})}oauthTokenWithUserCredentials(e,t,a,s){if(!OauthUtils.assertAvailable(e))throw new Error("'username' Required");if(!OauthUtils.assertAvailable(t))throw new Error("'password' Required");OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.User_Credentials,client_id:this.clientId,client_secret:this.clientSecret,username:e,password:t,scope:a.join(" ")},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof s&&s(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof s&&s(t,e)}})}oauthTokenWithAuthorizationCode(e,t,a){OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.Authorization_Code,code:e,redirect_uri:t,client_id:this.clientId,client_secret:this.clientSecret},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)}})}oauthRefreshToken(e,a){OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.Refresh_Token,refresh_token:e,client_id:this.clientId,client_secret:this.clientSecret},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)}})}oauthVerifyToken(e,a){OauthRequest.post({url:this.verifyTokenUrl,params:{access_token:e},success:e=>{var t=OauthResponse.parseVerificationResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseVerificationResponse(e.responseText);"function"==typeof a&&a(t,e)}})}}var OauthGrantType,OauthRequestMethod;!function(e){e.Client_Credentials="client_credentials",e.Authorization_Code="authorization_code",e.User_Credentials="password",e.Refresh_Token="refresh_token",e.Auto="auto"}(OauthGrantType=OauthGrantType||{}),function(e){e.GET="get",e.POST="post",e.PUT="put",e.DELETE="delete"}(OauthRequestMethod=OauthRequestMethod||{});class OauthRequest{constructor(){this.xhttp=new XMLHttpRequest}static get(e){const t=new OauthRequest;t.username=e.username,t.password=e.password,t.withCredentials=e.withCredentials,t.withAccessToken=e.withAccessToken,t.method=OauthRequestMethod.GET,t.url=e.url,t.headers=e.headers,t.query=e.query,t.params=e.params,t.success=e.success,t.fail=e.fail,t.request()}static post(e){const t=new OauthRequest;t.username=e.username,t.password=e.password,t.withCredentials=e.withCredentials,t.withAccessToken=e.withAccessToken,t.method=OauthRequestMethod.POST,t.url=e.url,t.headers=e.headers,t.query=e.query,t.params=e.params,t.success=e.success,t.fail=e.fail,t.request()}static put(e){const t=new OauthRequest;t.username=e.username,t.password=e.password,t.withCredentials=e.withCredentials,t.withAccessToken=e.withAccessToken,t.method=OauthRequestMethod.PUT,t.url=e.url,t.headers=e.headers,t.query=e.query,t.params=e.params,t.success=e.success,t.fail=e.fail,t.request()}static delete(e){const t=new OauthRequest;t.username=e.username,t.password=e.password,t.withCredentials=e.withCredentials,t.withAccessToken=e.withAccessToken,t.method=OauthRequestMethod.DELETE,t.url=e.url,t.headers=e.headers,t.query=e.query,t.params=e.params,t.success=e.success,t.fail=e.fail,t.request()}request(){if(null!=this.username&&void 0!==this.username||(this.username=""),null!=this.password&&void 0!==this.password||(this.password=""),null!=this.withCredentials&&void 0!==this.withCredentials||(this.withCredentials=!1),null!=this.withAccessToken&&void 0!==this.withAccessToken||(this.withAccessToken=!1),OauthUtils.assertAvailable(this.query)&&(null==this.url.match(/('?')/)?this.url+="?"+OauthUtils.urlEncodeObject(this.query):this.url+="&"+OauthUtils.urlEncodeObject(this.query)),this.method===OauthRequestMethod.GET&&OauthUtils.assertAvailable(this.params)&&(null==this.url.match(/('?')/)?this.url+="?"+OauthUtils.urlEncodeObject(this.params):this.url+="&"+OauthUtils.urlEncodeObject(this.params)),this.xhttp.withCredentials=this.withCredentials,this.xhttp.open(this.method.toString().toLowerCase(),this.url),this.xhttp.onreadystatechange=()=>{this.xhttp.readyState===this.xhttp.DONE&&(200===this.xhttp.status?"function"==typeof this.success&&this.success(this.xhttp,this.xhttp.responseText):"function"==typeof this.fail&&this.fail(this.xhttp))},null!==this.headers&&"object"==typeof this.headers)for(const t in this.headers)this.headers.hasOwnProperty(t)&&null!==this.headers[t]&&void 0!==this.headers[t]&&this.xhttp.setRequestHeader(t,this.headers[t]);var e;this.withCredentials&&this.xhttp.setRequestHeader("Authorization","Basic "+btoa(this.username+":"+this.password)),this.withAccessToken&&this.xhttp.setRequestHeader("Authorization",OauthStorage.tokenType+" "+OauthStorage.accessToken),this.method===OauthRequestMethod.GET?this.xhttp.send():this.params instanceof FormData?this.xhttp.send(this.params):(this.xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e=OauthUtils.urlEncodeObject(this.params),this.xhttp.send(e))}}class OauthResponse{static parseVerificationResponse(e){e=OauthUtils.parseJson(e),e=new OauthVerificationResponse(e);return e&&OauthUtils.assertAvailable(e.success)||e&&OauthUtils.assertAvailable(e.error)?e:null}static parseAuthorizationResponse(e){e=OauthUtils.parseJson(e),e=new OauthAuthorizationResponse(e);return e&&OauthUtils.assertAvailable(e.code)||e&&OauthUtils.assertAvailable(e.error)?e:null}static parseTokenResponse(e){e=OauthUtils.parseJson(e),e=new OauthTokenResponse(e);return e&&OauthUtils.assertAvailable(e.accessToken)||e&&OauthUtils.assertAvailable(e.error)?e:null}}class OauthVerificationResponse{constructor(e){e&&(this.success=e.success,this.error=e.error,this.errorDescription=e.error_description)}}class OauthAuthorizationResponse{constructor(e){e&&(this.state=e.state,this.code=e.code,this.error=e.error,this.errorDescription=e.error_description)}}class OauthTokenResponse{constructor(e){e&&(this.accessToken=e.access_token,this.refreshToken=e.refresh_token,this.tokenType=e.token_type,this.accessScope=e.scope,this.expiresIn=e.expires_in,this.error=e.error,this.errorDescription=e.error_description)}}export{OauthStorage,OauthUtils,Oauth,OauthGrantType,OauthRequestMethod,OauthRequest,OauthResponse,OauthVerificationResponse,OauthAuthorizationResponse,OauthTokenResponse};