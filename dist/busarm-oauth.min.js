var OauthStorageKeys,OauthGrantType,OauthRequestMethod;!function(e){e.AccessTokenKey="access_token",e.RefreshTokenKey="refresh_token",e.AccessScopeKey="scope",e.TokenTypeKey="token_type",e.ExpiresInKey="expires_in",e.CurrentStateKey="current_state"}(OauthStorageKeys=OauthStorageKeys||{});class OauthStorage{get(t){return new Promise(e=>{e(OauthStorage.get(t))})}set(t,a){return new Promise(e=>{e(OauthStorage.set(t,a))})}remove(t){return new Promise(e=>{e(OauthStorage.remove(t))})}clearAll(){return new Promise(e=>{e(OauthStorage.clearAll())})}static set(e,t,a=!1){a?"undefined"!=typeof sessionStorage&&sessionStorage.setItem(e,t):"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}static get(e){if("undefined"!=typeof sessionStorage){var t=sessionStorage.getItem(e);if(OauthUtils.assertAvailable(t))return t}if("undefined"!=typeof localStorage){t=localStorage.getItem(e);if(OauthUtils.assertAvailable(t))return t}return null}static remove(e){"undefined"!=typeof localStorage&&localStorage.removeItem(e),"undefined"!=typeof sessionStorage&&sessionStorage.removeItem(e)}static clearAll(e=!1){"undefined"!=typeof localStorage&&localStorage.clear(),e&&"undefined"!=typeof sessionStorage&&sessionStorage.clear()}static set accessToken(e){OauthStorage.set(OauthStorageKeys.AccessTokenKey,e)}static get accessToken(){return OauthStorage.get(OauthStorageKeys.AccessTokenKey)}static get refreshToken(){return OauthStorage.get(OauthStorageKeys.RefreshTokenKey)}static get accessScope(){return OauthStorage.get(OauthStorageKeys.AccessScopeKey)}static get expiresIn(){return OauthStorage.get(OauthStorageKeys.ExpiresInKey)}static get tokenType(){return OauthStorage.get(OauthStorageKeys.TokenTypeKey)}}class OauthUtils{static parseJWT(e){e=e.split(".");return e&&3==e.length?atob(e[1]):null}static hasJWTExpired(e){e=this.parseJson(this.parseJWT(e)),e=e?e.exp:null;return!e||parseInt(e)<Math.floor(Date.now()/1e3)+10}static hasTokenExpired(e){if(e=e||OauthStorage.accessToken,OauthUtils.assertAvailable(e)){if(OauthUtils.parseJWT(e)&&!OauthUtils.hasJWTExpired(e))return!1;if(OauthUtils.assertAvailable(OauthStorage.expiresIn))return parseInt(OauthStorage.expiresIn)<Math.floor(Date.now()/1e3)+10}return!0}static safeString(e){return OauthUtils.assertAvailable(e)?e:""}static safeInt(e){return OauthUtils.assertAvailable(e)?e:0}static assertAvailable(e){return null!=e&&void 0!==e&&""!==e}static count(e){let t=0;for(const a in e)e.hasOwnProperty(a)&&t++;return t}static mergeObj(t,a){return Object.keys(a).forEach(e=>{a.hasOwnProperty(e)&&(Array.isArray(t)?t.push(a[e]):t[this.count(t)]=a[e])}),t}static urlEncodeObject(e){const o=(e,t,a)=>{const s=[];for(const i in e[t]){var r;e[t].hasOwnProperty(i)&&null!==e[t][i]&&void 0!==e[t][i]&&("object"==typeof e[t][i]||Array.isArray(e[t][i])?(r=a+"["+i+"]",this.mergeObj(s,o(e[t],i,r))):s.push(encodeURIComponent(a+"["+i+"]")+"="+encodeURIComponent(e[t][i])))}return s};const t=(e=>{const t=[];if(null!==e&&"object"==typeof e)for(const a in e)e.hasOwnProperty(a)&&null!==e[a]&&void 0!==e[a]&&("object"==typeof e[a]||Array.isArray(e[a])?this.mergeObj(t,o(e,a,a)):t.push(a+"="+encodeURIComponent(e[a])));return t})(e);return 0<t.length?t.join("&"):""}static parseJson(e){try{return JSON.parse(e)}catch(e){return null}}static getUrlParam(e,t){t=t||location.href,t=decodeURIComponent(t),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");const a=new RegExp("[\\?&]"+e+"=([^&#]*)");e=a.exec(t);return null==e?null:e[1]}static stripUrlParams(e){return OauthUtils.assertAvailable(e)?e.split("?")[0]:e}static generateKey(t){OauthUtils.assertAvailable(t)||(t=16);let a="";var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let e=0;e<t;e++)a+=s.charAt(Math.floor(Math.random()*s.length));return a}}class Oauth{constructor(e){if(!OauthUtils.assertAvailable(e.clientId))throw new Error("'clientId' Required");if(this.clientId=e.clientId,!OauthUtils.assertAvailable(e.clientSecret))throw new Error("'clientSecret' Required");if(this.clientSecret=e.clientSecret,!OauthUtils.assertAvailable(e.authorizeUrl))throw new Error("'authorizeUrl'  Required");if(this.authorizeUrl=e.authorizeUrl,!OauthUtils.assertAvailable(e.tokenUrl))throw new Error("'tokenUrl' Required");if(this.tokenUrl=e.tokenUrl,!OauthUtils.assertAvailable(e.verifyTokenUrl))throw new Error("'verifyTokenUrl' Required");this.verifyTokenUrl=e.verifyTokenUrl,OauthUtils.assertAvailable(e.storage)?this.storage=e.storage:this.storage=new OauthStorage}saveAccess(e){this.storage.set(OauthStorageKeys.AccessTokenKey,OauthUtils.safeString(e.accessToken)),this.storage.set(OauthStorageKeys.RefreshTokenKey,OauthUtils.safeString(e.refreshToken)),this.storage.set(OauthStorageKeys.AccessScopeKey,OauthUtils.safeString(e.accessScope)),this.storage.set(OauthStorageKeys.TokenTypeKey,OauthUtils.safeString(e.tokenType)),this.storage.set(OauthStorageKeys.ExpiresInKey,String(OauthUtils.safeInt(Math.floor(Date.now()/1e3)+e.expiresIn)))}clearAccess(){this.storage.remove(OauthStorageKeys.AccessTokenKey),this.storage.remove(OauthStorageKeys.RefreshTokenKey),this.storage.remove(OauthStorageKeys.AccessScopeKey),this.storage.remove(OauthStorageKeys.TokenTypeKey),this.storage.remove(OauthStorageKeys.ExpiresInKey),this.storage.remove(OauthStorageKeys.CurrentStateKey)}authorizeAccess(r){let i=OauthUtils.assertAvailable(r.grant_type)?r.grant_type:OauthGrantType.Client_Credentials;const o=OauthUtils.assertAvailable(r.allowed_grant_types)?r.allowed_grant_types:[],n=OauthUtils.assertAvailable(r.redirect_uri)?r.redirect_uri:OauthUtils.stripUrlParams(location.origin),l=OauthUtils.assertAvailable(r.scope)?r.scope:[];let h=OauthUtils.assertAvailable(r.state)?r.state:OauthUtils.generateKey(32);const c=()=>{switch(i){case OauthGrantType.Auto:i=OauthUtils.assertAvailable(r.user_id)||OauthUtils.assertAvailable(OauthUtils.getUrlParam("code"))?OauthGrantType.Authorization_Code:OauthUtils.assertAvailable(r.username)&&OauthUtils.assertAvailable(r.password)?OauthGrantType.User_Credentials:OauthGrantType.Client_Credentials,o.includes(i)?c():r.callback(!1);break;case OauthGrantType.Authorization_Code:var e,t=OauthUtils.getUrlParam("code"),a=OauthUtils.getUrlParam("error"),s=OauthUtils.getUrlParam("error_description");OauthUtils.assertAvailable(t)?(e=OauthStorage.get(OauthStorageKeys.CurrentStateKey),(h=OauthUtils.assertAvailable(e)?e:h)===OauthUtils.getUrlParam("state")?this.oauthTokenWithAuthorizationCode(t,n,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(OauthStorage.remove(OauthStorageKeys.CurrentStateKey),this.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken),location.replace(OauthUtils.stripUrlParams(window.location.href))):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&r.callback(!1,e.errorDescription):"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!1)}):"function"==typeof r.callback&&r.callback(!1,"Failed authorize access. CSRF Verification Failed")):OauthUtils.assertAvailable(a)?(OauthStorage.remove(OauthStorageKeys.CurrentStateKey),OauthUtils.assertAvailable(s)?"function"==typeof r.callback&&r.callback(!1,s):"function"==typeof r.callback&&r.callback(!1,"Failed authorize access")):this.oauthAuthorize(l,n,r.user_id,h);break;case OauthGrantType.User_Credentials:this.oauthTokenWithUserCredentials(r.username,r.password,l,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(this.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken)):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&r.callback(!1,e.errorDescription):"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!1)});break;default:OauthGrantType.Client_Credentials;this.oauthTokenWithClientCredentials(l,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(this.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken)):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&r.callback(!1,e.errorDescription):"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!1)})}};var e,t,a=e=>{this.oauthRefreshToken(e,(e,t)=>{OauthUtils.assertAvailable(e)?OauthUtils.assertAvailable(e.accessToken)?(this.saveAccess(e),"function"==typeof r.callback&&r.callback(OauthStorage.accessToken)):OauthUtils.assertAvailable(e.error)?"function"==typeof r.callback&&(r.callback(!1,e.errorDescription),this.clearAccess(),c()):"function"==typeof r.callback&&(this.clearAccess(),r.callback(!1)):"function"==typeof r.callback&&r.callback(!1)})};OauthUtils.assertAvailable(OauthUtils.getUrlParam("access_token"))?(e=OauthUtils.getUrlParam("access_token"),OauthUtils.hasTokenExpired(e)?"function"==typeof r.callback&&r.callback(!1):"function"==typeof r.callback&&r.callback(!OauthUtils.assertAvailable(e)||e)):(e=OauthStorage.accessToken,t=OauthStorage.refreshToken,OauthUtils.assertAvailable(e)?OauthUtils.hasTokenExpired(e)?OauthUtils.assertAvailable(t)?a(t):c():"function"==typeof r.callback&&r.callback(e):c())}hasExpired(){return OauthUtils.hasTokenExpired(OauthStorage.accessToken)}oauthAuthorize(e,t,a,s){if(!OauthUtils.assertAvailable(t))throw new Error("'redirect_url' Required");OauthStorage.set(OauthStorageKeys.CurrentStateKey,s,!0);e={client_id:this.clientId,scope:e.join(" "),state:s,response_type:"code",user_id:a,redirect_uri:t},s=this.authorizeUrl+"?"+OauthUtils.urlEncodeObject(e);window.open(s,"_blank")}oauthAuthorizeWithEmail(e,t,a,s){if(!OauthUtils.assertAvailable(t))throw new Error("'redirect_url' Required");OauthStorage.set(OauthStorageKeys.CurrentStateKey,s,!0);e={client_id:this.clientId,scope:e.join(" "),state:s,response_type:"code",email:a,redirect_uri:t},s=this.authorizeUrl+"?"+OauthUtils.urlEncodeObject(e);window.open(s,"_blank")}oauthAuthorizeImplicit(e,t,a,s){if(!OauthUtils.assertAvailable(t))throw new Error("'redirect_url' Required");if(!OauthUtils.assertAvailable(e))throw new Error("'scope' Required");OauthStorage.set(OauthStorageKeys.CurrentStateKey,s,!0);e={client_id:this.clientId,scope:e.join(" "),state:s,response_type:"token",user_id:a,redirect_uri:t},s=this.authorizeUrl+"?"+OauthUtils.urlEncodeObject(e);window.open(s,"_blank")}oauthTokenWithClientCredentials(e,a){OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.Client_Credentials,client_id:this.clientId,client_secret:this.clientSecret,scope:e.join(" ")},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)}})}oauthTokenWithUserCredentials(e,t,a,s){if(!OauthUtils.assertAvailable(e))throw new Error("'username' Required");if(!OauthUtils.assertAvailable(t))throw new Error("'password' Required");OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.User_Credentials,client_id:this.clientId,client_secret:this.clientSecret,username:e,password:t,scope:a.join(" ")},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof s&&s(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof s&&s(t,e)}})}oauthTokenWithAuthorizationCode(e,t,a){OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.Authorization_Code,code:e,redirect_uri:t,client_id:this.clientId,client_secret:this.clientSecret},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)}})}oauthRefreshToken(e,a){OauthRequest.post({url:this.tokenUrl,params:{grant_type:OauthGrantType.Refresh_Token,refresh_token:e,client_id:this.clientId,client_secret:this.clientSecret},success:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseTokenResponse(e.responseText);"function"==typeof a&&a(t,e)}})}oauthVerifyToken(e,a){OauthRequest.get({url:this.verifyTokenUrl,accessToken:e,success:e=>{var t=OauthResponse.parseVerificationResponse(e.responseText);"function"==typeof a&&a(t,e)},fail:e=>{var t=OauthResponse.parseVerificationResponse(e.responseText);"function"==typeof a&&a(t,e)}})}}!function(e){e.Client_Credentials="client_credentials",e.Authorization_Code="authorization_code",e.User_Credentials="password",e.Refresh_Token="refresh_token",e.Auto="auto"}(OauthGrantType=OauthGrantType||{}),function(e){e.GET="get",e.POST="post",e.PUT="put",e.DELETE="delete"}(OauthRequestMethod=OauthRequestMethod||{});class OauthRequest{constructor(e,t=OauthRequestMethod.GET){this.data=e,this.method=t,this.xhttp=new XMLHttpRequest}static get(e){const t=new OauthRequest(e,OauthRequestMethod.GET);t.request()}static post(e){const t=new OauthRequest(e,OauthRequestMethod.POST);t.request()}static put(e){const t=new OauthRequest(e,OauthRequestMethod.PUT);t.request()}static delete(e){const t=new OauthRequest(e,OauthRequestMethod.DELETE);t.request()}request(){if(OauthUtils.assertAvailable(this.data.username)||(this.data.username=""),OauthUtils.assertAvailable(this.data.password)||(this.data.password=""),OauthUtils.assertAvailable(this.data.withCredentials)||(this.data.withCredentials=!1),OauthUtils.assertAvailable(this.data.withAccessToken)||(this.data.withAccessToken=!1),OauthUtils.assertAvailable(this.data.query)&&(null==this.data.url.match(/('?')/)?this.data.url+="?"+OauthUtils.urlEncodeObject(this.data.query):this.data.url+="&"+OauthUtils.urlEncodeObject(this.data.query)),this.method===OauthRequestMethod.GET&&OauthUtils.assertAvailable(this.data.params)&&(null==this.data.url.match(/('?')/)?this.data.url+="?"+OauthUtils.urlEncodeObject(this.data.params):this.data.url+="&"+OauthUtils.urlEncodeObject(this.data.params)),this.xhttp.withCredentials=this.data.withCredentials,this.xhttp.open(this.method.toString().toLowerCase(),this.data.url),this.xhttp.onreadystatechange=()=>{this.xhttp.readyState===this.xhttp.DONE&&(200===this.xhttp.status?this.data.success&&"function"==typeof this.data.success&&this.data.success(this.xhttp,this.xhttp.responseText):this.data.fail&&"function"==typeof this.data.fail&&this.data.fail(this.xhttp))},null!==this.data.headers&&"object"==typeof this.data.headers)for(const t in this.data.headers)this.data.headers.hasOwnProperty(t)&&null!==this.data.headers[t]&&void 0!==this.data.headers[t]&&this.xhttp.setRequestHeader(t,this.data.headers[t]);var e;this.data.withCredentials&&this.xhttp.setRequestHeader("Authorization","Basic "+Buffer.from(this.data.username+":"+this.data.password).toString("base64")),this.data.withAccessToken&&this.xhttp.setRequestHeader("Authorization",(this.data.accessTokenType||"Bearer")+" "+this.data.accessToken),this.method===OauthRequestMethod.GET?this.xhttp.send():this.data.params instanceof FormData?this.xhttp.send(this.data.params):(this.xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e=OauthUtils.urlEncodeObject(this.data.params),this.xhttp.send(e))}}class OauthResponse{static parseVerificationResponse(e){e=OauthUtils.parseJson(e),e=new OauthVerificationResponse(e);return e&&OauthUtils.assertAvailable(e.success)||e&&OauthUtils.assertAvailable(e.error)?e:null}static parseAuthorizationResponse(e){e=OauthUtils.parseJson(e),e=new OauthAuthorizationResponse(e);return e&&OauthUtils.assertAvailable(e.code)||e&&OauthUtils.assertAvailable(e.error)?e:null}static parseTokenResponse(e){e=OauthUtils.parseJson(e),e=new OauthTokenResponse(e);return e&&OauthUtils.assertAvailable(e.accessToken)||e&&OauthUtils.assertAvailable(e.error)?e:null}}class OauthVerificationResponse{constructor(e){e&&(this.success=e.success,this.error=e.error,this.errorDescription=e.error_description)}}class OauthAuthorizationResponse{constructor(e){e&&(this.state=e.state,this.code=e.code,this.error=e.error,this.errorDescription=e.error_description)}}class OauthTokenResponse{constructor(e){e&&(this.accessToken=e.access_token,this.refreshToken=e.refresh_token,this.tokenType=e.token_type,this.accessScope=e.scope,this.expiresIn=e.expires_in,this.error=e.error,this.errorDescription=e.error_description)}}export{OauthStorageKeys,OauthStorage,OauthUtils,Oauth,OauthGrantType,OauthRequestMethod,OauthRequest,OauthResponse,OauthVerificationResponse,OauthAuthorizationResponse,OauthTokenResponse};